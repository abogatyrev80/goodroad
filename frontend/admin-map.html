<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Good Road - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #2a2a2a;
            border-bottom: 1px solid #333;
            z-index: 1000;
            position: relative;
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .control-button {
            background: #4CAF50;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .control-button:hover {
            background: #45a049;
        }
        
        .control-button.secondary {
            background: #666;
        }
        
        .control-button.secondary:hover {
            background: #777;
        }
        
        .map-container {
            height: calc(100vh - 60px);
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .legend {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(26, 26, 26, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 16px;
            min-width: 200px;
            z-index: 1000;
            border: 1px solid #333;
        }
        
        .legend h3 {
            font-size: 14px;
            margin-bottom: 12px;
            color: #4CAF50;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .stats {
            position: absolute;
            bottom: 16px;
            left: 16px;
            background: rgba(26, 26, 26, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 16px;
            min-width: 300px;
            z-index: 1000;
            border: 1px solid #333;
        }
        
        .stats h3 {
            font-size: 14px;
            margin-bottom: 12px;
            color: #4CAF50;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 12px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .stat-label {
            color: #888;
            font-size: 10px;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .stat-value {
            color: white;
            font-size: 16px;
            font-weight: 600;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2000;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2000;
            background: rgba(244, 67, 54, 0.9);
            padding: 20px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è Good Road - –ö–∞—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö</h1>
        <div class="controls">
            <button class="control-button secondary" onclick="refreshData()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="control-button" onclick="fitBounds()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
            <button class="control-button secondary" onclick="toggleHeatmap()">–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞</button>
        </div>
    </div>
    
    <div class="map-container">
        <div id="map"></div>
        
        <div class="legend">
            <h3>üìä –õ–µ–≥–µ–Ω–¥–∞</h3>
            <div class="legend-item">
                <div class="legend-color" style="background: #4CAF50;"></div>
                <span>–•–æ—Ä–æ—à–∏–µ –¥–æ—Ä–æ–≥–∏ (70%+)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF9800;"></div>
                <span>–°—Ä–µ–¥–Ω–∏–µ –¥–æ—Ä–æ–≥–∏ (40-70%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #F44336;"></div>
                <span>–ü–ª–æ—Ö–∏–µ –¥–æ—Ä–æ–≥–∏ (<40%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFC107;"></div>
                <span>–ù–µ–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #9C27B0;"></div>
                <span>–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è</span>
            </div>
        </div>
        
        <div class="stats">
            <h3>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">–í—Å–µ–≥–æ —Ç–æ—á–µ–∫</div>
                    <div class="stat-value" id="totalPoints">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ</div>
                    <div class="stat-value" id="verifiedPoints">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π</div>
                    <div class="stat-value" id="hazardPoints">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">–°—Ä. –∫–∞—á–µ—Å—Ç–≤–æ</div>
                    <div class="stat-value" id="avgQuality">-</div>
                </div>
            </div>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
        
        <div id="error" class="error" style="display: none;">
            <div>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>
            <button class="control-button" onclick="initMap()" style="margin-top: 12px;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
        </div>
    </div>

    <script>
        let map;
        let markers = [];
        let heatmap;
        let isHeatmapVisible = false;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º OpenStreetMap —á–µ—Ä–µ–∑ Leaflet)
        async function initMap() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É (—Ü–µ–Ω—Ç—Ä - –ú–æ—Å–∫–≤–∞)
                if (!window.L) {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º Leaflet –µ—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                    await loadLeaflet();
                }
                
                if (map) {
                    map.remove();
                }
                
                map = L.map('map').setView([55.7558, 37.6176], 10);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π –∫–∞—Ä—Ç—ã OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å backend
                await loadData();
                
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Map initialization error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }
        
        async function loadLeaflet() {
            return new Promise((resolve, reject) => {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º CSS
                const cssLink = document.createElement('link');
                cssLink.rel = 'stylesheet';
                cssLink.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                document.head.appendChild(cssLink);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º JS
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        async function loadData() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É
                const analyticsResponse = await fetch('/api/admin/analytics');
                if (analyticsResponse.ok) {
                    const analytics = await analyticsResponse.json();
                    updateStats(analytics);
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤
                const sensorResponse = await fetch('/api/admin/sensor-data?limit=1000');
                if (sensorResponse.ok) {
                    const sensorData = await sensorResponse.json();
                    addDataPoints(sensorData.data);
                }
                
                console.log('‚úÖ Data loaded successfully');
                
            } catch (error) {
                console.error('Error loading data:', error);
                throw error;
            }
        }
        
        function updateStats(analytics) {
            document.getElementById('totalPoints').textContent = analytics.total_points || 0;
            document.getElementById('verifiedPoints').textContent = analytics.verified_points || 0;
            document.getElementById('hazardPoints').textContent = analytics.hazard_points || 0;
            document.getElementById('avgQuality').textContent = 
                analytics.avg_road_quality ? analytics.avg_road_quality + '%' : '-';
        }
        
        function addDataPoints(dataPoints) {
            // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            const bounds = [];
            
            dataPoints.forEach(point => {
                const color = getPointColor(point);
                const size = getPointSize(point);
                
                // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
                const marker = L.circleMarker([point.latitude, point.longitude], {
                    color: 'white',
                    weight: 2,
                    fillColor: color,
                    fillOpacity: 0.8,
                    radius: size
                }).addTo(map);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
                const popupContent = createPopupContent(point);
                marker.bindPopup(popupContent);
                
                markers.push(marker);
                bounds.push([point.latitude, point.longitude]);
            });
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö —Ç–æ—á–µ–∫
            if (bounds.length > 0) {
                map.fitBounds(bounds);
            }
            
            console.log(\`‚úÖ Added \${dataPoints.length} data points to map\`);
        }
        
        function getPointColor(point) {
            if (!point.is_verified) return '#FFC107'; // –ñ–µ–ª—Ç—ã–π - –Ω–µ–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
            
            if (point.hazard_type) {
                switch (point.severity) {
                    case 'critical': return '#F44336'; // –ö—Ä–∞—Å–Ω—ã–π
                    case 'high': return '#FF5722';     // –¢–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π
                    case 'medium': return '#FF9800';   // –û—Ä–∞–Ω–∂–µ–≤—ã–π
                    default: return '#9C27B0';         // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
                }
            }
            
            // –¶–≤–µ—Ç –ø–æ –∫–∞—á–µ—Å—Ç–≤—É –¥–æ—Ä–æ–≥–∏
            if (point.road_quality_score < 40) return '#F44336';      // –ö—Ä–∞—Å–Ω—ã–π - –ø–ª–æ—Ö–æ
            if (point.road_quality_score < 70) return '#FF9800';      // –û—Ä–∞–Ω–∂–µ–≤—ã–π - —Å—Ä–µ–¥–Ω–µ
            return '#4CAF50';                                          // –ó–µ–ª–µ–Ω—ã–π - —Ö–æ—Ä–æ—à–æ
        }
        
        function getPointSize(point) {
            if (point.hazard_type) return 8; // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –±–æ–ª—å—à–µ
            return 6; // –û–±—ã—á–Ω—ã–µ —Ç–æ—á–∫–∏
        }
        
        function createPopupContent(point) {
            const date = new Date(point.timestamp).toLocaleString('ru-RU');
            const hazardText = point.hazard_type ? 
                \`<div style="color: \${getPointColor(point)}; margin: 8px 0;"><strong>‚ö†Ô∏è \${point.hazard_type} (\${point.severity})</strong></div>\` : '';
            const statusText = point.is_verified ? 
                '<span style="color: #4CAF50;">‚úÖ –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ</span>' : 
                '<span style="color: #FFC107;">‚è≥ –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</span>';
                
            return \`
                <div style="min-width: 200px; font-size: 12px; line-height: 1.4;">
                    <div style="font-weight: 600; margin-bottom: 8px;">üìç –¢–æ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö</div>
                    <div><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> \${point.latitude.toFixed(6)}, \${point.longitude.toFixed(6)}</div>
                    <div><strong>–í—Ä–µ–º—è:</strong> \${date}</div>
                    <div><strong>–°–∫–æ—Ä–æ—Å—Ç—å:</strong> \${point.speed.toFixed(1)} –∫–º/—á</div>
                    <div><strong>–ö–∞—á–µ—Å—Ç–≤–æ –¥–æ—Ä–æ–≥–∏:</strong> <span style="color: \${getPointColor(point)};">\${point.road_quality_score}%</span></div>
                    <div><strong>–¢–æ—á–Ω–æ—Å—Ç—å GPS:</strong> ¬±\${point.accuracy.toFixed(1)}–º</div>
                    \${hazardText}
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd;">
                        \${statusText}
                    </div>
                    \${point.admin_notes ? \`<div style="margin-top: 4px;"><strong>–ó–∞–º–µ—Ç–∫–∏:</strong> \${point.admin_notes}</div>\` : ''}
                </div>
            \`;
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        async function refreshData() {
            document.getElementById('loading').style.display = 'block';
            try {
                await loadData();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }
        
        function fitBounds() {
            if (markers.length > 0) {
                const bounds = markers.map(marker => marker.getLatLng());
                map.fitBounds(bounds);
            }
        }
        
        function toggleHeatmap() {
            if (isHeatmapVisible) {
                // –°–∫—Ä—ã—Ç—å —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É, –ø–æ–∫–∞–∑–∞—Ç—å –º–∞—Ä–∫–µ—Ä—ã
                if (heatmap) {
                    map.removeLayer(heatmap);
                }
                markers.forEach(marker => map.addLayer(marker));
                isHeatmapVisible = false;
                document.querySelector('[onclick="toggleHeatmap()"]').textContent = '–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞';
            } else {
                // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É, —Å–∫—Ä—ã—Ç—å –º–∞—Ä–∫–µ—Ä—ã
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É
                markers.forEach(marker => map.removeLayer(marker));
                isHeatmapVisible = true;
                document.querySelector('[onclick="toggleHeatmap()"]').textContent = '–û–±—ã—á–Ω—ã–π –≤–∏–¥';
                alert('–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>